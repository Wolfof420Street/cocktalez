default_platform(:ios)

platform :ios do
  desc "Push a new beta build to TestFlight"
  lane :beta do
    # 1. Setup CI (Create temporary keychain)
    setup_ci

    # 2. Sync Certificates (Read-Only for CI security)
    # Ensure 'git_url' matches your PRIVATE Match Repo SSH URL
    # We use the environment variable MATCH_GIT_URL if set, or you can hardcode it here.
    # But for a public repo, it's safer to pass it or rely on Matchfile.
    match(
      type: "appstore",
      readonly: is_ci, # CI should not create/revoke certs
      git_url: ENV["MATCH_GIT_URL"] # Passed from Workflow or set in Matchfile
    )

    # 3. Build the App
    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      flutter_build_args: "--release --build-number=#{ENV['GITHUB_RUN_NUMBER']}" # Sync build number with CI
    )

    # 4. Upload to TestFlight
    # Uses API Key from environment variables (ASC_KEY_ID, etc.)
    upload_to_testflight(
      skip_waiting_for_build_processing: true
    )
  end
end
